name: Build_XG_040G_MD_Airoha

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      log_switch:
        description: "è¯¦ç»†ç¼–è¯‘æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰"
        required: false
        default: false
        type: boolean
      ssh_connect:
        description: "ç¼–è¯‘å‰å¼€å¯SSHè¿æ¥ï¼ˆç”¨äºè°ƒè¯•ï¼‰"
        required: false
        default: false
        type: boolean
      clean_build:
        description: "æ¸…ç†ç¼–è¯‘ç¯å¢ƒï¼ˆå®Œæ•´é‡ç¼–ï¼‰"
        required: false
        default: false
        type: boolean

env:
  CONFIG_FILE: "config/xg-040g.config"
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: v23.05.4
  FEEDS_CONF: feeds.conf.default
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  CCACHE_DIR: /home/runner/work/ccache
  CCACHE_MAXSIZE: 5G
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          docker-images: true

      - name: Space usage check
        run: df -h

      # SSHè°ƒè¯•æ”¯æŒ
      - name: Setup SSH connection
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh_connect == 'true' }}
        timeout-minutes: 60
        with:
          limit-access-to-actor: true

      - name: Setup environment dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            gawk \
            git \
            libncurses5-dev \
            libssl-dev \
            python3 \
            python3-setuptools \
            rsync \
            swig \
            unzip \
            wget \
            file \
            ccache \
            time \
            qemu-utils \
            upx-ucl \
            u-boot-tools \
            device-tree-compiler \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu

      - name: Set timezone
        run: |
          sudo timedatectl set-timezone "$TZ" || sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: Ensure Python build tools
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install pyelftools

      - name: Clone OpenWrt source code
        run: |
          git clone --branch "$REPO_BRANCH" "$REPO_URL" openwrt
          cd openwrt
          git rev-parse HEAD > commit-info.txt
          # æ£€æŸ¥Airohaç›®æ ‡
          if [ ! -d "target/linux/airoha" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°Airohaç›®æ ‡ç›®å½•"
          fi

      # æ¸…ç†ç¼–è¯‘ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
      - name: Clean build directories
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          rm -rf /home/runner/work/{dl,staging_dir,build_dir,ccache}
          echo "å·²æ¸…ç†ç¼–è¯‘ç¼“å­˜"

      - name: Setup build directories
        run: |
          mkdir -p /home/runner/work/{dl,staging_dir,build_dir,ccache}
          for dir in dl staging_dir build_dir; do
            rm -rf openwrt/$dir
            ln -sf /home/runner/work/$dir openwrt/$dir
          done
          
          mkdir -p ${{ env.CCACHE_DIR }}
          ln -sf ${{ env.CCACHE_DIR }} openwrt/ccache
          df -h

      - name: Restore dl cache
        uses: actions/cache@v4
        with:
          path: /home/runner/work/dl
          key: ${{ runner.os }}-airoha-dl-${{ hashFiles('feeds.conf.default', 'config/xg-040g.config') }}
          restore-keys: |
            ${{ runner.os }}-airoha-dl-

      - name: Restore ccache
        uses: actions/cache@v4
        id: ccache-cache
        with:
          path: /home/runner/work/ccache
          key: ${{ runner.os }}-airoha-ccache-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-airoha-ccache-

      - name: Setup ccache
        run: |
          ccache -M ${{ env.CCACHE_MAXSIZE }}
          ccache -s

      # å…³é”®ä¿®å¤ï¼šæ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: Check config file
        run: |
          if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: ${{ env.CONFIG_FILE }}"
            echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la config/
            exit 1
          else
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: ${{ env.CONFIG_FILE }}"
            echo "é…ç½®æ–‡ä»¶å‰20è¡Œï¼š"
            head -20 "${{ env.CONFIG_FILE }}"
          fi

      # ========== æ‰§è¡Œ diy-part1.shï¼ˆç¼–è¯‘å‰é…ç½®ï¼‰ ==========
      - name: Run diy-part1.sh (pre-feed configuration)
        run: |
          if [ -f "scripts/diy-part1.sh" ]; then
            echo "æ‰§è¡Œ diy-part1.sh..."
            chmod +x scripts/diy-part1.sh
            bash scripts/diy-part1.sh
          else
            echo "âš ï¸ æœªæ‰¾åˆ° diy-part1.shï¼Œè·³è¿‡"
          fi

      - name: Update & Install feeds
        working-directory: ./openwrt
        run: |
          # å¤åˆ¶feedsé…ç½®
          if [ -f ../$FEEDS_CONF ]; then
            echo "ä½¿ç”¨è‡ªå®šä¹‰feedsé…ç½®"
            cp -f ../$FEEDS_CONF ./feeds.conf.default
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰feedsé…ç½®ï¼Œä½¿ç”¨é»˜è®¤"
          fi
          
          # æ›´æ–°feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a -f

      # ========== æ‰§è¡Œ update-packages.shï¼ˆå®‰è£…ç¬¬ä¸‰æ–¹åŒ…ï¼‰ ==========
      - name: Run update-packages.sh (third-party packages)
        run: |
          if [ -f "scripts/update-packages.sh" ]; then
            echo "æ‰§è¡Œ update-packages.sh..."
            chmod +x scripts/update-packages.sh
            bash scripts/update-packages.sh
          else
            echo "âš ï¸ æœªæ‰¾åˆ° update-packages.shï¼Œè·³è¿‡"
          fi

      # ========== æ‰§è¡Œ diy-part2.shï¼ˆç¼–è¯‘å‰æœ€ç»ˆé…ç½®ï¼‰ ==========
      - name: Run diy-part2.sh (post-feed configuration)
        run: |
          if [ -f "scripts/diy-part2.sh" ]; then
            echo "æ‰§è¡Œ diy-part2.sh..."
            chmod +x scripts/diy-part2.sh
            bash scripts/diy-part2.sh
          else
            echo "âš ï¸ æœªæ‰¾åˆ° diy-part2.shï¼Œè·³è¿‡"
          fi

      # ========== æ‰§è¡Œ check-config.shï¼ˆé…ç½®æ£€æŸ¥ï¼‰ ==========
      - name: Run check-config.sh (verify configuration)
        run: |
          if [ -f "scripts/check-config.sh" ]; then
            echo "æ‰§è¡Œ check-config.sh..."
            chmod +x scripts/check-config.sh
            bash scripts/check-config.sh
          else
            echo "âš ï¸ æœªæ‰¾åˆ° check-config.shï¼Œè·³è¿‡"
          fi

      - name: Configure firmware
        working-directory: ./openwrt
        run: |
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp -fv "../$CONFIG_FILE" .config
          
          # ç”Ÿæˆå®Œæ•´é…ç½®
          make defconfig
          
          # ä¿å­˜æœ€ç»ˆé…ç½®
          cp .config defconfig-final.config
          
          # éªŒè¯Airohaé…ç½®
          echo "=== Airohaå¹³å°é…ç½®éªŒè¯ ==="
          grep -E "CONFIG_TARGET_airoha|CONFIG_PACKAGE_airoha" .config || echo "âš ï¸ æœªæ‰¾åˆ°Airohaé…ç½®"
          
          # è¾“å‡ºå…³é”®é…ç½®ç»Ÿè®¡
          echo "=== é…ç½®ç»Ÿè®¡ ==="
          grep -c "CONFIG_PACKAGE_" .config | xargs echo "å·²å¯ç”¨è½¯ä»¶åŒ…æ•°é‡:"
          grep -c "=y" .config | xargs echo "æ€»å¯ç”¨é€‰é¡¹æ•°é‡:"

      - name: Upload config files
        uses: actions/upload-artifact@v4
        with:
          name: build-config-${{ github.run_id }}
          path: |
            ${{ env.CONFIG_FILE }}
            openwrt/defconfig-final.config
            openwrt/feeds.conf.default
            openwrt/commit-info.txt

      - name: Download packages
        working-directory: ./openwrt
        run: |
          # ä¸‹è½½é‡è¯•æœºåˆ¶
          for i in {1..3}; do
            echo "ä¸‹è½½å°è¯• $i/3..."
            make download -j8 V=s && break || sleep 10
          done
          
          # æ¸…ç†æŸåæ–‡ä»¶
          find dl -type f -size -1024c -delete
          
          # ç»Ÿè®¡ä¸‹è½½
          echo "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶ç»Ÿè®¡ï¼š"
          find dl -type f | wc -l | xargs echo "æ€»æ–‡ä»¶æ•°:"
          du -sh dl

      - name: Compile OpenWrt firmware
        id: compile
        timeout-minutes: 180
        run: |
          cd openwrt
          
          echo "ç¼–è¯‘å‰ç£ç›˜ä½¿ç”¨ï¼š"
          df -h
          
          START_TIME=$(date +%s)
          
          # æ ¹æ®log_switché€‰æ‹©ç¼–è¯‘æ¨¡å¼
          if [[ "${{ inputs.log_switch }}" == "true" ]]; then
            # è°ƒè¯•æ¨¡å¼ï¼šå•çº¿ç¨‹è¯¦ç»†æ—¥å¿—
            make -j1 V=s 2>&1 | tee compile.log
            COMPILE_STATUS=${PIPESTATUS[0]}
          else
            # æ­£å¸¸æ¨¡å¼ï¼šå¤šçº¿ç¨‹ç¼–è¯‘
            make -j$(nproc) 2>&1 | tee compile.log
            COMPILE_STATUS=${PIPESTATUS[0]}
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ç¼–è¯‘è€—æ—¶: $((DURATION/60))åˆ† $((DURATION%60))ç§’"
          
          if [ $COMPILE_STATUS -eq 0 ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo "status=failed" >> $GITHUB_OUTPUT
            # è¾“å‡ºé”™è¯¯æ—¥å¿—æœ€å50è¡Œ
            echo "æœ€å50è¡Œé”™è¯¯æ—¥å¿—ï¼š"
            tail -50 compile.log
            exit $COMPILE_STATUS
          fi
          
          # æå–è®¾å¤‡åç§°
          DEVICE_NAME=$(grep -o 'CONFIG_TARGET.*DEVICE_[^=]*=y' .config | head -1 | sed 's/.*DEVICE_\(.*\)=y/\1/')
          if [[ -n "$DEVICE_NAME" ]]; then
            echo "DEVICE_NAME=_${DEVICE_NAME}" >> "$GITHUB_ENV"
          fi
          
          echo "FILE_DATE=_$(date +%Y%m%d%H%M)" >> "$GITHUB_ENV"
          
          # ccacheç»Ÿè®¡
          echo "ccache ç»Ÿè®¡ï¼š"
          ccache -s

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /home/runner/work/ccache
          key: ${{ runner.os }}-airoha-ccache-${{ github.run_id }}

      - name: Prepare firmware artifacts
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
        run: |
          # æŸ¥æ‰¾å›ºä»¶ç›®å½•
          FIRMWARE_DIR=$(find openwrt/bin/targets -type d -name "*image*" -o -name "*squashfs*" | head -1)
          
          if [ -z "$FIRMWARE_DIR" ]; then
            FIRMWARE_DIR=$(find openwrt/bin/targets -type f -name "*.bin" -o -name "*.img" -o -name "*.tar" | head -1 | xargs dirname)
          fi
          
          if [ -n "$FIRMWARE_DIR" ]; then
            echo "å›ºä»¶ç›®å½•: $FIRMWARE_DIR"
            cd "$FIRMWARE_DIR"
            rm -rf packages 2>/dev/null || true
            echo "FIRMWARE=$PWD" >> $GITHUB_ENV
            
            echo "æ‰¾åˆ°çš„å›ºä»¶æ–‡ä»¶ï¼š"
            ls -lh *.bin *.img *.tar *.itb 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          else
            echo "âš ï¸ æ‰¾ä¸åˆ°å›ºä»¶ç›®å½•"
          fi

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
        with:
          name: XG-040G-MD_Airoha${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: |
            ${{ env.FIRMWARE }}/*.bin
            ${{ env.FIRMWARE }}/*.img
            ${{ env.FIRMWARE }}/*.tar
            ${{ env.FIRMWARE }}/*.itb
            ${{ env.FIRMWARE }}/*.manifest
          if-no-files-found: warn

      - name: Generate release notes
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
        run: |
          cd openwrt
          COMMIT_MSG=$(git log -1 --pretty=%s)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          cat <<EOF > release.txt
          # ğŸš€ OpenWrt å›ºä»¶ for XG-040G-MD (Airoha EN7581)
          
          ## ğŸ“¦ å›ºä»¶ä¿¡æ¯
          - **è®¾å¤‡å‹å·**: Bell XG-040G-MD
          - **SoCå¹³å°**: Airoha EN7581 (aarch64_cortex-a53)
          - **NPUåŠ é€Ÿ**: âœ… å·²å¯ç”¨
          - **æ„å»ºæ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")
          - **æºç ç‰ˆæœ¬**: $REPO_BRANCH@$COMMIT_HASH
          - **æœ€æ–°æäº¤**: $COMMIT_MSG
          
          ## âœ¨ ä¸»è¦ç‰¹æ€§
          - Airoha EN7581 NPU ç¡¬ä»¶åŠ é€Ÿ
          - HomeProxy / SmartDNS / MWAN3
          - ksmbd / vsFTPd / Transmission
          - Zerotier / UPnP
          - USB 3.0 å…¨æ”¯æŒ
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          å›ºä»¶æ–‡ä»¶åœ¨ä¸‹æ–¹Artifactsä¸­
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - é»˜è®¤IP: 192.168.3.1
          - é»˜è®¤æ— å¯†ç 
          EOF

      - name: Publish GitHub Release
        uses: ncipollo/release-action@v1
        if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
        with:
          tag: v${{ github.run_number }}-airoha
          name: "XG-040G-MD Airoha å›ºä»¶ #${{ github.run_number }}"
          bodyFile: release.txt
          artifacts: "${{ env.FIRMWARE }}/*"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 14
          keep_minimum_runs: 10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
