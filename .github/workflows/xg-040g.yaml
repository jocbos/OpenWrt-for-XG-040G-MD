name: Build_XG_040G_MD_Airoha

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      log_switch:
        description: "è¯¦ç»†ç¼–è¯‘æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰"
        required: false
        default: false
        type: boolean
      ssh_connect:
        description: "ç¼–è¯‘å‰å¼€å¯SSHè¿æ¥ï¼ˆç”¨äºè°ƒè¯•ï¼‰"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths:
      - ".github/workflows/xg-040g-md-mybranch.yml"
      - "config/**"
      - "scripts/**"
      - "feeds.conf.default"

env:
  CONFIG_FILE: "config/xg-040g-md.config"
  # ä¿®æ”¹ï¼šä½¿ç”¨ä½ çš„æˆåŠŸæ¨¡æ¿ä¸­çš„æºç åœ°å€ï¼ˆå¦‚æœä¸åŒè¯·ä¿®æ”¹ï¼‰
  REPO_URL: https://github.com/openwrt/openwrt.git
  # Airoha EN7581 æ”¯æŒéœ€è¦ç‰¹å®šåˆ†æ”¯
  REPO_BRANCH: v23.05.4  # æˆ–è€…ä½¿ç”¨ mainï¼Œä½†23.05å¯¹airohaæ”¯æŒæ›´ç¨³å®š
  FEEDS_CONF: feeds.conf.default
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  # ä¼˜åŒ–ï¼šä½¿ç”¨GitHub Actionsçš„ä¸´æ—¶ç›®å½•
  CCACHE_DIR: /home/runner/work/ccache
  CCACHE_MAXSIZE: 5G
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04  # ä¿æŒ22.04ç¨³å®šç‰ˆ

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          docker-images: true

      - name: Space usage check
        run: df -h

      # æ–°å¢ï¼šSSHè°ƒè¯•æ”¯æŒ
      - name: Setup SSH connection
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh_connect == 'true' }}
        timeout-minutes: 60
        with:
          limit-access-to-actor: true

      - name: Setup environment dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          # Airoha EN7581 éœ€è¦çš„ä¾èµ–
          sudo apt install -y \
            build-essential \
            gawk \
            git \
            libncurses5-dev \
            libssl-dev \
            python3 \
            python3-setuptools \
            rsync \
            swig \
            unzip \
            wget \
            file \
            ccache \
            time \
            qemu-utils \
            upx-ucl \
            u-boot-tools \
            device-tree-compiler \
            # Airohaç‰¹æœ‰å·¥å…·
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu

      - name: Set timezone
        run: |
          sudo timedatectl set-timezone "$TZ" || sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: Ensure Python build tools
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install pyelftools  # Airohaéœ€è¦

      - name: Clone OpenWrt source code
        run: |
          # ä¿®æ”¹ï¼šä½¿ç”¨å®Œæ•´å…‹éš†ä»¥ç¡®ä¿Airohaæ”¯æŒ
          git clone --branch "$REPO_BRANCH" "$REPO_URL" openwrt
          cd openwrt
          git rev-parse HEAD > commit-info.txt
          # æ£€æŸ¥Airohaç›®æ ‡æ˜¯å¦å­˜åœ¨
          if [ ! -d "target/linux/airoha" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°Airohaç›®æ ‡ç›®å½•ï¼Œå¯èƒ½éœ€è¦æ·»åŠ è¡¥ä¸"
          fi

      - name: Setup build directories
        run: |
          mkdir -p /home/runner/work/{dl,staging_dir,build_dir,ccache}
          for dir in dl staging_dir build_dir; do
            rm -rf openwrt/$dir
            ln -sf /home/runner/work/$dir openwrt/$dir
          done
          
          mkdir -p ${{ env.CCACHE_DIR }}
          ln -sf ${{ env.CCACHE_DIR }} openwrt/ccache
          df -h

      - name: Restore dl cache
        uses: actions/cache@v4
        with:
          path: /home/runner/work/dl
          # ä¿®æ”¹ï¼šç¼“å­˜keyåŒ…å«Airohaæ ‡è¯†
          key: ${{ runner.os }}-airoha-dl-${{ hashFiles('feeds.conf.default', 'config/xg-040g-md.config') }}
          restore-keys: |
            ${{ runner.os }}-airoha-dl-

      - name: Restore ccache
        uses: actions/cache@v4
        id: ccache-cache
        with:
          path: /home/runner/work/ccache
          key: ${{ runner.os }}-airoha-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-airoha-ccache-

      - name: Setup ccache
        run: |
          ccache -M ${{ env.CCACHE_MAXSIZE }}
          ccache -s

      # æ–°å¢ï¼šAirohaå¹³å°ç‰¹å®šè¡¥ä¸
      - name: Apply Airoha platform patches
        working-directory: ./openwrt
        run: |
          # ç¡®ä¿NPUå›ºä»¶ç›®å½•å­˜åœ¨
          mkdir -p package/firmware/airoha-en7581-npu-firmware
          
          # åˆ›å»ºNPUå›ºä»¶åŒ…Makefileï¼ˆå¦‚æœå®˜æ–¹æ²¡æœ‰ï¼‰
          if [ ! -f package/firmware/airoha-en7581-npu-firmware/Makefile ]; then
            cat > package/firmware/airoha-en7581-npu-firmware/Makefile << 'EOF'
include $(TOPDIR)/rules.mk

PKG_NAME:=airoha-en7581-npu-firmware
PKG_RELEASE:=1
PKG_LICENSE:=Proprietary

include $(INCLUDE_DIR)/package.mk

define Package/airoha-en7581-npu-firmware
  SECTION:=firmware
  CATEGORY:=Firmware
  TITLE:=Airoha EN7581 NPU firmware
  DEPENDS:=@TARGET_airoha_an7581
endef

define Package/airoha-en7581-npu-firmware/description
  NPU firmware for Airoha EN7581 platform
endef

define Build/Compile
endef

define Package/airoha-en7581-npu-firmware/install
  $(INSTALL_DIR) $(1)/lib/firmware
  # è¿™é‡Œéœ€è¦ä»æºç æˆ–ç½‘ç›˜è·å–å®é™…å›ºä»¶æ–‡ä»¶
  # ä¸´æ—¶åˆ›å»ºå ä½æ–‡ä»¶
  touch $(1)/lib/firmware/en7581_npu.bin
endef

$(eval $(call BuildPackage,airoha-en7581-npu-firmware))
EOF
          fi

      - name: Update & Install feeds
        working-directory: ./openwrt
        run: |
          if [ -f ../$FEEDS_CONF ]; then
            echo "ä½¿ç”¨è‡ªå®šä¹‰feedsé…ç½®: ../$FEEDS_CONF"
            cp -f ../$FEEDS_CONF ./feeds.conf.default
          fi
          
          # æ›´æ–°feeds
          ./scripts/feeds update -a
          
          # å®‰è£…æ‰€æœ‰åŒ…
          ./scripts/feeds install -a -f
          
          # ç‰¹åˆ«å®‰è£…Airohaç›¸å…³åŒ…
          ./scripts/feeds install kmod-airoha-hw-accel
          ./scripts/feeds install airoha-cpufreq

      - name: Apply hotfixes
        working-directory: ./openwrt
        run: |
          # LuCI hotfix (ä¿æŒä½ çš„åŸæœ‰hotfix)
          CBI_JS="feeds/luci/modules/luci-base/htdocs/luci-static/resources/cbi.js"
          if [ -f "$CBI_JS" ]; then
            echo "åº”ç”¨cbi.js hotfix..."
            sed -i \
              -e "s/return[[:space:]]*''\.format\.apply(arguments\[0\], a);/return String.prototype.format.apply(arguments[0], a.slice(1));/g" \
              -e "s/return[[:space:]]*''\.nobr\.apply(arguments\[0\], a);/return String.prototype.nobr.apply(arguments[0], a.slice(1));/g" \
              "$CBI_JS"
          fi
          
          # Airohaç‰¹å®šï¼šä¿®å¤NPUæ¨¡å—åŠ è½½
          mkdir -p files/etc/modules.d
          echo "airoha-hw-accel" > files/etc/modules.d/99-airoha-hw-accel

      - name: Install third-party packages
        working-directory: ./openwrt/package
        run: |
          if [ -f $GITHUB_WORKSPACE/scripts/update-packages.sh ]; then
            chmod +x $GITHUB_WORKSPACE/scripts/update-packages.sh
            bash $GITHUB_WORKSPACE/scripts/update-packages.sh
          else
            echo "âš ï¸ update-packages.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          
      - name: Configure firmware
        working-directory: ./openwrt
        run: |
          if [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
            echo "ä½¿ç”¨é…ç½®æ–‡ä»¶: $GITHUB_WORKSPACE/$CONFIG_FILE"
            cp -fv "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $GITHUB_WORKSPACE/$CONFIG_FILE"
            exit 1
          fi
          
          # ç¡®ä¿Airohaç›®æ ‡æ­£ç¡®
          make defconfig
          
          # éªŒè¯Airohaé…ç½®
          echo "=== éªŒè¯Airohaå¹³å°é…ç½® ==="
          grep -E "CONFIG_TARGET_airoha|CONFIG_PACKAGE_airoha" .config
          
          cp .config defconfig-final.config
          
          # è¾“å‡ºå…³é”®é…ç½®
          echo "=== å…³é”®é…ç½®ä¿¡æ¯ ==="
          grep -E "CONFIG_TARGET|CONFIG_PACKAGE_luci|CONFIG_PACKAGE_airoha" .config | head -30

      - name: Upload config files
        uses: actions/upload-artifact@v4
        with:
          name: build-config-${{ github.run_id }}
          path: |
            config/xg-040g-md.config
            openwrt/defconfig-final.config
            openwrt/feeds.conf.default
            openwrt/commit-info.txt

      - name: Download packages
        working-directory: ./openwrt
        run: |
          # å¢åŠ é‡è¯•æœºåˆ¶
          for i in {1..3}; do
            echo "ä¸‹è½½å°è¯• $i/3..."
            make download -j8 V=s && break || sleep 10
          done
          
          # æ¸…ç†æŸåæ–‡ä»¶
          find dl -type f -size -1024c -delete
          
          # ç»Ÿè®¡ä¸‹è½½
          echo "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶ç»Ÿè®¡ï¼š"
          find dl -type f -name "*.bin" -o -name "*.fw" | wc -l
          du -sh dl

      - name: Compile OpenWrt firmware
        id: compile
        timeout-minutes: 180
        run: |
          cd openwrt
          
          echo "ç¼–è¯‘å‰ç£ç›˜ä½¿ç”¨ï¼š"
          df -h
          
          START_TIME=$(date +%s)
          
          # Airohaå¹³å°å»ºè®®ä½¿ç”¨å•çº¿ç¨‹é¦–æ¬¡ç¼–è¯‘
          if [[ "${{ inputs.log_switch }}" == "true" ]]; then
            # è°ƒè¯•æ¨¡å¼ï¼šå•çº¿ç¨‹è¯¦ç»†æ—¥å¿—
            make -j1 V=s || {
              COMPILE_STATUS=$?
              echo "ç¼–è¯‘å¤±è´¥ï¼Œæ”¶é›†è¯Šæ–­ä¿¡æ¯..."
              df -h
              du -h -d1 . | sort -h | tail -n 30
              # æ£€æŸ¥Airohaç›¸å…³é”™è¯¯
              echo "=== Airohaç›¸å…³é”™è¯¯æ—¥å¿— ==="
              grep -i "airoha\|en7581\|npu" logs/compile.log 2>/dev/null || true
              exit $COMPILE_STATUS
            }
          else
            # æ­£å¸¸æ¨¡å¼ï¼šå…ˆç”¨å•çº¿ç¨‹æ£€æŸ¥é…ç½®
            make defconfig
            # ç„¶åç”¨å¤šçº¿ç¨‹ç¼–è¯‘
            make -j$(nproc) || {
              echo "ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹æŸ¥çœ‹é”™è¯¯..."
              make -j1 V=s
            }
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ç¼–è¯‘è€—æ—¶: $((DURATION/60))åˆ† $((DURATION%60))ç§’"
          
          # æå–è®¾å¤‡åç§°
          DEVICE_NAME=$(grep -o 'CONFIG_TARGET.*DEVICE_[^=]*=y' .config | head -1 | sed 's/.*DEVICE_\(.*\)=y/\1/')
          if [[ -n "$DEVICE_NAME" ]]; then
            echo "DEVICE_NAME=_${DEVICE_NAME}" >> "$GITHUB_ENV"
          fi
          
          echo "FILE_DATE=_$(date +%Y%m%d%H%M)" >> "$GITHUB_ENV"
          echo "status=success" >> $GITHUB_OUTPUT
          
          # ccacheç»Ÿè®¡
          echo "ccache ç»Ÿè®¡ï¼š"
          ccache -s

      - name: Prepare firmware artifacts
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true'
        run: |
          # æŸ¥æ‰¾Airohaå›ºä»¶ç›®å½•
          FIRMWARE_DIR=$(find openwrt/bin/targets -name "*airoha*" -type d | head -1)
          
          if [ -z "$FIRMWARE_DIR" ]; then
            FIRMWARE_DIR=$(find openwrt/bin/targets -type f -name "*.bin" -o -name "*.img" -o -name "*.tar" | head -1 | xargs dirname)
          fi
          
          if [ -n "$FIRMWARE_DIR" ]; then
            echo "å›ºä»¶ç›®å½•: $FIRMWARE_DIR"
            cd "$FIRMWARE_DIR"
            rm -rf packages
            echo "FIRMWARE=$PWD" >> $GITHUB_ENV
            
            echo "æ‰¾åˆ°çš„å›ºä»¶æ–‡ä»¶ï¼š"
            ls -lh *.bin *.img *.tar *.itb 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶"
          else
            echo "âŒ æ‰¾ä¸åˆ°å›ºä»¶ç›®å½•"
            exit 1
          fi

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        if: env.UPLOAD_FIRMWARE == 'true'
        with:
          name: XG-040G-MD_Airoha${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: |
            ${{ env.FIRMWARE }}/*.bin
            ${{ env.FIRMWARE }}/*.img
            ${{ env.FIRMWARE }}/*.tar
            ${{ env.FIRMWARE }}/*.itb
            ${{ env.FIRMWARE }}/*.manifest
          if-no-files-found: warn

      - name: Generate release notes
        id: tag
        if: env.UPLOAD_RELEASE == 'true'
        run: |
          cd openwrt
          COMMIT_MSG=$(git log -1 --pretty=%s)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          cat <<EOF > release.txt
          # ğŸš€ OpenWrt å›ºä»¶ for XG-040G-MD (Airoha EN7581)
          
          ## ğŸ“¦ å›ºä»¶ä¿¡æ¯
          - **è®¾å¤‡å‹å·**: Bell XG-040G-MD
          - **SoCå¹³å°**: Airoha EN7581 (aarch64_cortex-a53)
          - **NPUåŠ é€Ÿ**: âœ… å·²å¯ç”¨
          - **æ„å»ºæ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")
          - **æºç ç‰ˆæœ¬**: $REPO_BRANCH@$COMMIT_HASH
          - **æœ€æ–°æäº¤**: $COMMIT_MSG
          
          ## âœ¨ ä¸»è¦ç‰¹æ€§
          - Airoha EN7581 NPU ç¡¬ä»¶åŠ é€Ÿ
          - HomeProxy / SmartDNS / MWAN3
          - ksmbd / vsFTPd / Transmission
          - Zerotier / UPnP
          - USB 3.0 å…¨æ”¯æŒ
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          å›ºä»¶æ–‡ä»¶åœ¨ä¸‹æ–¹Artifactsä¸­ï¼Œè¯·æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ã€‚
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·æœºå‰è¯·å¤‡ä»½åŸå‚å›ºä»¶
          - é»˜è®¤IP: 192.168.3.1
          - é»˜è®¤æ— å¯†ç 
          EOF

      - name: Publish GitHub Release
        uses: ncipollo/release-action@v1
        if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
        with:
          tag: v${{ github.run_number }}-airoha
          name: "XG-040G-MD Airoha å›ºä»¶ #${{ github.run_number }}"
          bodyFile: release.txt
          artifacts: "${{ env.FIRMWARE }}/*"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /home/runner/work/ccache
          key: ${{ runner.os }}-airoha-ccache-${{ github.sha }}

      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 14
          keep_minimum_runs: 10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}